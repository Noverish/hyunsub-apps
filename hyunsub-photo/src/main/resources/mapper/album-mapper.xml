<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kim.hyunsub.photo.repository.mapper.AlbumMapper">
    <select id="countById">
        SELECT COUNT(*)
        FROM album
        WHERE id = #{id}
    </select>

    <select id="select" resultType="Album">
        SELECT a.id, a.name, a.thumbnail_photo_id, a.reg_dt
        FROM album a
        INNER JOIN album_owner ao ON ao.album_id = a.id
        <where>
            <if test="userId != null">AND ao.user_id = #{userId}</if>
            <if test="owner != null">AND ao.owner = #{owner}</if>
            <if test="thumbnailPhotoIds != null and !thumbnailPhotoIds.isEmpty()">
                AND a.thumbnail_photo_id IN (<foreach collection="thumbnailPhotoIds" item="v" separator=",">#{v}</foreach>)
            </if>
        </where>
        ORDER BY a.reg_dt DESC
        <if test="page != null">
            LIMIT #{page.pageSize} OFFSET #{page.offset}
        </if>
    </select>

    <select id="selectOne" resultType="Album">
        SELECT a.id, a.name, a.thumbnail_photo_id, a.reg_dt
        FROM album a
        WHERE a.id = #{id}
    </select>

    <select id="selectWithUserId" resultType="Album">
        SELECT a.id, a.name, a.thumbnail_photo_id, a.reg_dt
        FROM album_owner ao
        INNER JOIN album a ON a.id = ao.album_id
        <where>
            AND ao.album_id = #{albumId}
            AND ao.user_id = #{userId}
            <if test="owner != null">AND ao.owner = #{owner}</if>
        </where>
    </select>

    <update id="update">
        UPDATE album
        SET name = #{name},
            thumbnail_photo_id = #{thumbnailPhotoId}
        WHERE id = #{id}
    </update>

    <insert id="insert">
        INSERT INTO album
        (id, name, thumbnail_photo_id, reg_dt)
        VALUES
        (#{id}, #{name}, #{thumbnailPhotoId}, #{regDt})
    </insert>

    <insert id="insertAll">
        INSERT INTO album
        (id, name, thumbnail_photo_id, reg_dt)
        VALUES
        <foreach collection="entities" item="v" separator=",">
            (#{v.id}, #{v.name}, #{v.thumbnailPhotoId}, #{v.regDt})
        </foreach>
    </insert>

    <delete id="deleteById">
        DELETE FROM album
        WHERE id = #{id}
    </delete>

    <delete id="deleteByIds">
        DELETE FROM album
        WHERE id IN <foreach collection="ids" item="v" separator="," open="(" close=")">#{v}</foreach>
    </delete>
</mapper>
